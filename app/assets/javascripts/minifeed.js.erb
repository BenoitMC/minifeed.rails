class Minifeed {
  static get entryModalEl() {
    return find("#entry-modal")
  }

  static get entryModalBs() {
    return bootstrap.Modal.getOrCreateInstance(this.entryModalEl)
  }

  static get entryCarouselBs() {
    return bootstrap.Carousel.getOrCreateInstance(this.entryModalEl.find(".carousel"))
  }

  static openEntry(id) {
    this.entryModalEl.find(".carousel-inner").innerHTML = "";
    this.entryModalBs.show()
    this.addEntry({id, method: "append", active: true})
    this.adjustPreviousAndNextEntries()
  }

  static addEntry({id, method, active = false}) {
    const url = find(`#entries-list a[data-entry-id='${id}']`).dataset.url
    const item = document.createElement("turbo-frame")
    item.dataset.entryId = id
    item.id = `entry_${id}`
    item.src = url
    item.loading = "lazy"
    item.classList.add("entry","carousel-item")
    item.classList.toggle("active", active)
    this.entryModalEl.find(".modal-body .carousel-inner")[method](item)
  }

  static adjustPreviousAndNextEntries() {
    const currentItem = this.entryModalEl.querySelector(".carousel-item.active")
    const currentEntryId = currentItem.dataset.entryId

    if (currentItem.matches(":first-child")) {
      const previousEntryId = find(`#entries-list a[data-entry-id='${currentEntryId}']`).closest("li").previousElementSibling?.find("a[data-entry-id]")?.dataset?.entryId
      if (previousEntryId) {
        this.addEntry({id: previousEntryId, method: "prepend"})
      }
    }

    if (currentItem.matches(":last-child")) {
      const nextEntryId = find(`#entries-list a[data-entry-id='${currentEntryId}']`).closest("li").nextElementSibling?.find("a[data-entry-id]")?.dataset?.entryId
      if (nextEntryId) {
        this.addEntry({id: nextEntryId, method: "append"})
      }
    }
  }
}

Minifeed.actions = {
  help() {
    find("a[href$=keyboard-shortcuts]").click()
  },

  close_modal() {
    findAll(".modal.show").forEach(el => bootstrap.Modal.getInstance(el).hide())
  },

  previous_entry() {
    if (Minifeed.entryModalEl.matches(".show")) {
      Minifeed.entryCarouselBs.prev()
    } else {
      find("#entries-list li:last-child a.entry-name")?.click()
    }
  },

  next_entry() {
    if (Minifeed.entryModalEl.matches(".show")) {
      Minifeed.entryCarouselBs.next()
    } else {
      find("#entries-list li:first-child a.entry-name")?.click()
    }
  },

  mark_entry_as_un_read() {
    find(".entry.active input[type=checkbox][name*=read]")?.click()
  },

  mark_entry_as_un_starred() {
    find(".entry.active input[type=checkbox][name*=starred]")?.click()
  },

  open_reader_mode() {
    find(".entry.active .entry-reader_link")?.click()
  },

  open_internal() {
    find(".entry.active .entry-internal_link")?.click()
  },

  open_external() {
    find(".entry.active .entry-external_link")?.click()
  },

  reload_navigation() {
    let url = location.href + (location.href.includes("?") ? "&" : "?") + "layout=true"
    fetchText(url).then(text => {
      find("#header").replaceWith(parseDocument(text).find("#header"))
    })
  },

  set_theme() {
    if(document.body.dataset.theme) {
      document.body.dataset.bsTheme = document.body.dataset.theme
    } else {
      document.body.dataset.bsTheme = (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light")
    }
  },
}

if (typeof(Mousetrap) === "function") {
  Minifeed.define_keyboard_shortcuts = () => {
    <% KEYBOARD_SHORTCUTS.each do |id, keys| %>
      <% keys.each do |key| %>
        <%= "Mousetrap.bind('#{key}', Minifeed.actions.#{id})" %>
      <% end %>
    <% end %>
  }

  Minifeed.define_keyboard_shortcuts()
}

onEvent("click", ".open-entry", (ev, el) => {
  if (ev.ctrlKey || ev.metaKey) { return } // new tab
  ev.preventDefault()
  Minifeed.openEntry(el.dataset.entryId)
})

onEvent("slid.bs.carousel", "#entry-modal", () => {
  Minifeed.adjustPreviousAndNextEntries()
})

onEvent("click", ".entry-reader_link", (ev, el) => {
  ev.preventDefault()
  let iframe = parseFragment(`<iframe src='${el.href}' class='entry-iframe' />`)
  iframe.style.height = "0px"
  iframe.onload = () => iframe.style.height = iframe.contentDocument.querySelector("html").scrollHeight + "px"
  let content = el.closest(".entry.active").find(".entry-content")
  content.innerHTML = ""
  content.append(iframe)
})

onEvent("click", ".entry-internal_link", (ev, el) => {
  ev.preventDefault()
  let iframe = parseFragment(`<iframe src='${el.href}' class='entry-iframe' />`)
  el.closest(".entry.active").find(".entry-content").innerHTML = iframe.outerHTML
})

onEvent("click", "#entries-load-more a", (ev, el) => {
  ev.preventDefault()

  fetchText(el.href).then(text => {
    let html = parseDocument(text)
    html.findAll("#entries-list li").forEach(li => find("#entries-list").append(li))
    let loadButton = html.find("#entries-load-more")
    find("#entries-load-more").replaceWith(loadButton || "")
  })
})

onEvent("click", ".entry-body a", (ev, el) => {
  el.target = "_blank"
})

onEvent("change", ".entry-header form", (ev, el) => {
  el.requestSubmit()
})

onEvent("click", ".subnav-toggle", (ev, el) => {
  ev.preventDefault()
  el.closest(".subnav").classList.toggle("open")
})

onEvent("swiped-left", "#entry-modal", Minifeed.actions.next_entry)

onEvent("swiped-right", "#entry-modal", Minifeed.actions.previous_entry)

onEvent("turbo:load turbo:render", () => {
  find("#url")?.focus()
})

onEvent("turbo:load turbo:render", Minifeed.actions.set_theme)
window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", Minifeed.actions.set_theme)
